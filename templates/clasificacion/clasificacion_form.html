{% extends "guia_base.html" %}
{% import "components/forms/form_elements.html" as forms %}
{% import "components/clasificacion_styles.html" as clasificacion_styles %}

{% block title %}Clasificación de Racimos - {{ codigo_guia }}{% endblock %}

{% block styles %}
{{ super() }}
{{ clasificacion_styles.clasificacion_styles() }}
<style>
    /* Estilos mejorados específicos para clasificación */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.7);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    .loading-content {
        text-align: center;
        color: white;
        padding: 2rem;
    }
    .spinner-border {
        width: 3rem;
        height: 3rem;
    }
    .info-section {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .photo-section {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .classification-section {
        background: white;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .photo-preview {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        margin: 1rem 0;
        border: 1px solid #dee2e6;
    }
    .photo-status {
        display: flex;
        align-items: center;
        margin-bottom: 1rem;
    }
    .status-indicator {
        width: 1rem;
        height: 1rem;
        border-radius: 50%;
        margin-right: 0.5rem;
    }
    .status-pending {
        background-color: #ffc107;
    }
    .status-completed {
        background-color: #28a745;
    }
    .info-row {
        margin-bottom: 0.75rem;
        display: flex;
        flex-wrap: wrap;
    }
    .info-label {
        font-weight: 600;
        width: 180px;
        color: #6c757d;
    }
    .info-value {
        flex: 1;
        font-size: 1rem;
    }
    .weight-value {
        font-weight: 600;
        color: #198754;
    }
    .card-header {
        background-color: #f8f9fa;
        border-bottom: 1px solid #dee2e6;
        padding: 0.75rem 1rem;
    }
    .code-badge {
        font-size: 1rem;
        padding: 0.4rem 0.8rem;
        border-radius: 50px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row mb-3">
        <div class="col-12">
            <a href="{{ url_for('pesaje.lista_pesajes') }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-2"></i>Volver a Pesajes
            </a>
            <h2 class="mt-3">Clasificación de Racimos</h2>
            <p class="text-muted">Información de clasificación para la guía</p>
        </div>
    </div>

    <form id="main-form" method="POST" action="{{ url_for('clasificacion.registrar_clasificacion') }}" enctype="multipart/form-data" class="needs-validation" novalidate>
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="spinner-border text-light mb-3" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h2>Procesando clasificación...</h2>
                <p>Por favor espere mientras procesamos las imágenes.</p>
            </div>
        </div>

        <!-- Información del proveedor y guía -->
        <div class="info-section">
            <h5 class="card-header mb-3">Información General</h5>
            <div class="row">
                <div class="col-md-6">
                    <div class="info-row">
                        <div class="info-label">Código Guía:</div>
                        <div class="info-value"><span class="badge bg-primary code-badge">{{ codigo_guia }}</span></div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Código Proveedor:</div>
                        <div class="info-value">{{ codigo_proveedor }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Nombre Proveedor:</div>
                        <div class="info-value">{{ nombre_proveedor }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Cantidad de Racimos:</div>
                        <div class="info-value">{{ cantidad_racimos }}</div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-row">
                        <div class="info-label">Peso Bruto:</div>
                        <div class="info-value weight-value">{{ peso_bruto }} kg</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Tipo de Clasificación:</div>
                        <div class="info-value">
                            <span class="badge bg-{{ 'warning' if en_reclasificacion else 'primary' }}">
                                {{ 'Reclasificación' if en_reclasificacion else 'Primera clasificación' }}
                            </span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Tipo de Pesaje:</div>
                        <div class="info-value">
                            <span class="badge bg-{{ 'success' if tipo_pesaje == 'directo' else ('primary' if tipo_pesaje == 'bascula' else 'info') }}">
                                {% if tipo_pesaje == 'directo' %}
                                    Soporte Foto
                                {% elif tipo_pesaje == 'virtual' %}
                                    Manual
                                {% elif tipo_pesaje == 'bascula' %}
                                    Directo
                                {% else %}
                                    {{ tipo_pesaje|title if tipo_pesaje else 'No especificado' }}
                                {% endif %}
                            </span>
                        </div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Código Guía SAP:</div>
                        <div class="info-value">{{ codigo_guia_transporte_sap if codigo_guia_transporte_sap else 'No disponible' }}</div>
                    </div>
                    <div class="info-row">
                        <div class="info-label">Fecha/Hora Pesaje:</div>
                        <div class="info-value">{{ fecha_pesaje if fecha_pesaje else 'N/A' }} {{ hora_pesaje if hora_pesaje else '' }}</div>
                    </div>
                </div>
            </div>
            <!-- Contenedores para los resultados y acciones -->
            <div class="d-none">
                <input type="hidden" id="codigo" value="{{ codigo_proveedor }}">
                <input type="hidden" id="codigo_guia" name="codigo_guia" value="{{ codigo_guia }}">
                <input type="hidden" id="cantidad_racimos_hidden" value="{{ cantidad_racimos }}">
                <input type="hidden" id="nombreProveedor" value="{{ nombre_proveedor }}">
            </div>
        </div>

        <!-- Selección de tipo de clasificación -->
        <div class="classification-section">
            <h5 class="card-header mb-3">Tipo de Clasificación</h5>
            <div class="mb-3">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="clasificacionAutomatica" checked>
                    <label class="form-check-label" for="clasificacionAutomatica">
                        Clasificación Automática
                    </label>
                    <small class="form-text text-muted">Las fotos se almacenarán para su posterior procesamiento</small>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="clasificacionManual" checked>
                    <label class="form-check-label" for="clasificacionManual">
                        Clasificación Manual
                    </label>
                    <small class="form-text text-muted">
                        <span id="muestreoInfo">
                            {% if cantidad_racimos|int > 1000 %}
                            Clasificación basada en muestra de 100 racimos
                            {% else %}
                            Clasificación basada en muestra de 28 racimos
                            {% endif %}
                        </span>
                    </small>
                </div>
            </div>
            <div class="alert alert-warning d-none" id="clasificacionAlerta">
                Debe seleccionar al menos un tipo de clasificación
            </div>
        </div>

        <!-- Sección de Fotos -->
        <div class="photo-section" id="seccionFotos">
            <h5 class="card-header mb-3">Captura de Fotos</h5>
            <div class="row">
                {% for i in range(1, 4) %}
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Foto {{ i }}</h5>
                            <div class="photo-status">
                                <div class="status-indicator status-pending" id="status-foto-{{ i }}"></div>
                                <span id="status-text-{{ i }}">Pendiente</span>
                            </div>
                            <div class="mb-3">
                                <button class="btn btn-primary mb-2 w-100" id="btn-camara-{{ i }}">
                                    <i class="fas fa-camera"></i> Abrir Cámara
                                </button>
                                <video id="video-{{ i }}" class="w-100 d-none"></video>
                                <button class="btn btn-success mb-2 w-100 d-none" id="btn-capturar-{{ i }}">
                                    <i class="fas fa-camera"></i> Capturar Foto
                                </button>
                                <input type="file" class="form-control" id="foto-{{ i }}" name="foto-{{ i }}" accept="image/*">
                                <small class="text-muted">O seleccione una imagen desde su dispositivo</small>
                            </div>
                            <img id="preview-{{ i }}" class="photo-preview d-none">
                            <button class="btn btn-secondary mt-2 d-none" id="btn-retomar-{{ i }}">
                                Retomar Foto
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Sección de Clasificación Manual -->
        <div class="classification-section" id="seccionClasificacionManual">
            <h5 class="card-header mb-3">Clasificación Manual</h5>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label class="form-label">Racimos Verdes:</label>
                    <input type="number" class="form-control" id="verdes" name="verdes" min="0" step="0.01">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Racimos Sobremaduros:</label>
                    <input type="number" class="form-control" id="sobremaduros" name="sobremaduros" min="0" step="0.01">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Racimos con Daño en Corona:</label>
                    <input type="number" class="form-control" id="dano_corona" name="dano_corona" min="0" step="0.01">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Racimos con Pedúnculo Largo:</label>
                    <input type="number" class="form-control" id="pedunculo_largo" name="pedunculo_largo" min="0" step="0.01">
                </div>
                <div class="col-md-6 mb-3">
                    <label class="form-label">Racimos Podridos:</label>
                    <input type="number" class="form-control" id="podridos" name="podridos" min="0" step="0.01">
                </div>
            </div>
        </div>

        <!-- Sección de Resultados -->
        <!-- Eliminada según el plan -->
        
        <!-- Botones de acción -->
        <div class="classification-section">
            <div class="d-flex justify-content-end gap-2 mt-3">
                <button type="button" id="btn-cancelar" class="btn btn-secondary me-2">Cancelar</button>
                <button type="submit" id="btn-guardar" class="btn btn-success">Guardar Fotos y Clasificación Manual</button>
                <!-- Botones de prueba eliminados -->
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Utility function to show/hide loading indicator - defined at the top level
    function mostrarCarga(mostrar) {
        const loadingOverlay = document.getElementById('loadingOverlay');
        if (loadingOverlay) {
            loadingOverlay.style.display = mostrar ? 'flex' : 'none';
        } else {
            console.log('Loading overlay element not found');
        }
    }

    document.addEventListener("DOMContentLoaded", function() {
        // Referencias a elementos
        const loadingOverlay = document.getElementById('loadingOverlay');
        const btnGuardar = document.getElementById('btn-guardar');
        const btnCancelar = document.getElementById('btn-cancelar');
        
        // Botones y elementos de cámara para cada foto
        for (let i = 1; i <= 3; i++) {
            const btnCamara = document.getElementById(`btn-camara-${i}`);
            const btnCapturar = document.getElementById(`btn-capturar-${i}`);
            const btnRetomar = document.getElementById(`btn-retomar-${i}`);
            const video = document.getElementById(`video-${i}`);
            const preview = document.getElementById(`preview-${i}`);
            const fileInput = document.getElementById(`foto-${i}`);
            const statusIndicator = document.getElementById(`status-foto-${i}`);
            const statusText = document.getElementById(`status-text-${i}`);
            
            let stream = null;
            
            // Evento para abrir la cámara
            btnCamara.addEventListener('click', async (event) => {
                event.preventDefault(); // Prevenir comportamiento por defecto (redirección)
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    video.srcObject = stream;
                    video.classList.remove('d-none');
                    btnCapturar.classList.remove('d-none');
                    btnCamara.classList.add('d-none');
                    video.play();
                } catch (err) {
                    console.error("Error al acceder a la cámara:", err);
                    alert("No se pudo acceder a la cámara. Por favor, usa la opción de cargar archivo.");
                }
            });
            
            // Evento para capturar foto
            btnCapturar.addEventListener('click', (event) => {
                event.preventDefault(); // Prevenir si estuviera dentro de un form
                const canvas = document.createElement('canvas');
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Convertir a imagen y mostrar preview
                preview.src = canvas.toDataURL('image/jpeg');
                preview.classList.remove('d-none');
                
                // Detener cámara y ocultar elementos
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                video.classList.add('d-none');
                btnCapturar.classList.add('d-none');
                btnRetomar.classList.remove('d-none');
                
                // Actualizar estado
                statusIndicator.classList.remove('status-pending');
                statusIndicator.classList.add('status-completed');
                statusText.textContent = 'Completada';
                
                // Crear archivo desde el canvas
                canvas.toBlob(blob => {
                    const file = new File([blob], `foto-${i}.jpg`, { type: 'image/jpeg' });
                    const dataTransfer = new DataTransfer();
                    dataTransfer.items.add(file);
                    fileInput.files = dataTransfer.files;
                    
                    // Disparar evento change para que otros scripts detecten el cambio
                    const event = new Event('change', { bubbles: true });
                    fileInput.dispatchEvent(event);
                }, 'image/jpeg');
            });
            
            // Evento para retomar foto
            btnRetomar.addEventListener('click', (event) => {
                event.preventDefault(); // Prevenir si estuviera dentro de un form
                preview.classList.add('d-none');
                btnRetomar.classList.add('d-none');
                btnCamara.classList.remove('d-none');
                
                // Reiniciar estado
                statusIndicator.classList.remove('status-completed');
                statusIndicator.classList.add('status-pending');
                statusText.textContent = 'Pendiente';
                
                // Limpiar el input de archivo
                fileInput.value = '';
            });
            
            // Evento para cuando se selecciona un archivo
            fileInput.addEventListener('change', (e) => {
                if (fileInput.files && fileInput.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        preview.src = e.target.result;
                        preview.classList.remove('d-none');
                        btnRetomar.classList.remove('d-none');
                        
                        // Actualizar estado
                        statusIndicator.classList.remove('status-pending');
                        statusIndicator.classList.add('status-completed');
                        statusText.textContent = 'Completada';
                    };
                    reader.readAsDataURL(fileInput.files[0]);
                }
            });
        }
        
        // Cancelar y volver a la página anterior
        btnCancelar.addEventListener('click', () => {
            window.history.back();
        });

        // Validar el formulario antes de enviar
        document.getElementById('main-form').addEventListener('submit', function(e) {
            e.preventDefault(); // Prevenir el envío automático
            
            // Asegurarse de que al menos un tipo de clasificación esté seleccionado
            const checkAutomatica = document.getElementById('clasificacionAutomatica');
            const checkManual = document.getElementById('clasificacionManual');
            
            if (!checkAutomatica.checked && !checkManual.checked) {
                document.getElementById('clasificacionAlerta').classList.remove('d-none');
                return false;
            }
            
            // Verificar y validar los campos numéricos
            if (checkManual.checked) {
                // Asegurarse de que los valores vacíos se conviertan a cero
                document.getElementById('verdes').value = document.getElementById('verdes').value || "0";
                document.getElementById('sobremaduros').value = document.getElementById('sobremaduros').value || "0";
                document.getElementById('dano_corona').value = document.getElementById('dano_corona').value || "0";
                document.getElementById('pedunculo_largo').value = document.getElementById('pedunculo_largo').value || "0";
                document.getElementById('podridos').value = document.getElementById('podridos').value || "0";
                
                // Mostrar los valores que se van a enviar
                console.log("Valores a enviar:");
                console.log("Verdes:", document.getElementById('verdes').value);
                console.log("Sobremaduros:", document.getElementById('sobremaduros').value);
                console.log("Daño Corona:", document.getElementById('dano_corona').value);
                console.log("Pedúnculo Largo:", document.getElementById('pedunculo_largo').value);
                console.log("Podridos:", document.getElementById('podridos').value);
            }
            
            // --- Mover la confirmación y preparación aquí --- 
            if (confirm('¿Está seguro de guardar la clasificación manual y las fotos?')) {
                // Asegurarse de que los valores numéricos vacíos se conviertan a cero antes de enviar
                document.getElementById('verdes').value = document.getElementById('verdes').value || "0";
                document.getElementById('sobremaduros').value = document.getElementById('sobremaduros').value || "0";
                document.getElementById('dano_corona').value = document.getElementById('dano_corona').value || "0";
                document.getElementById('pedunculo_largo').value = document.getElementById('pedunculo_largo').value || "0";
                document.getElementById('podridos').value = document.getElementById('podridos').value || "0";
                
                // Mostrar los valores que se van a enviar (opcional, para debug)
                console.log("Valores manuales a enviar:", { 
                    verdes: document.getElementById('verdes').value,
                    sobremaduros: document.getElementById('sobremaduros').value,
                    dano_corona: document.getElementById('dano_corona').value,
                    pedunculo_largo: document.getElementById('pedunculo_largo').value,
                    podridos: document.getElementById('podridos').value
                });
                console.log("Archivos a enviar:", {
                    foto1: document.getElementById('foto-1').files.length > 0 ? document.getElementById('foto-1').files[0].name : 'Ninguno',
                    foto2: document.getElementById('foto-2').files.length > 0 ? document.getElementById('foto-2').files[0].name : 'Ninguno',
                    foto3: document.getElementById('foto-3').files.length > 0 ? document.getElementById('foto-3').files[0].name : 'Ninguno',
                });

                // Si confirma, permitir que el evento submit continúe su curso natural
                // NO llamar a this.submit() aquí, simplemente no prevenir el default.
            } else {
                 // Si cancela, prevenir el envío
                console.log("Envío cancelado por el usuario.");
                // No es necesario llamar a preventDefault aquí explícitamente
                // porque ya se llamó al inicio del handler. 
                // PERO, para mayor claridad, podríamos quitar el preventDefault() inicial
                // y ponerlo solo aquí. Vamos a probar así:
                // Quitamos el e.preventDefault() inicial y lo ponemos aquí.
                // *** REVISIÓN: Mejor dejar el preventDefault() al inicio y NO hacer nada más aquí si cancela.
                // El flujo se detendrá porque no se continúa.
            }
            // --- FIN de la lógica movida ---
        });
    });

    document.addEventListener('DOMContentLoaded', function() {
        // Manejar el botón Cancelar
        document.getElementById('btn-cancelar').addEventListener('click', function() {
            if (confirm('¿Está seguro de cancelar la clasificación? Los datos no guardados se perderán.')) {
                window.location.href = "{{ url_for('misc.ver_guia_centralizada', codigo_guia=codigo_guia) }}";
            }
        });
        
        // Manejar el botón Guardar Fotos y Clasificación Manual
        document.getElementById('btn-guardar').addEventListener('click', function(event) {
            // Validar que al menos una clasificación esté seleccionada -> YA NO ES NECESARIO
            /*
            if (!checkAutomatica.checked && !checkManual.checked) {
                alerta.classList.remove('d-none');
                return;
            }
            */
           
            // Prevenir el envío inmediato del formulario para poder hacer la confirmación
            event.preventDefault();
            
            // Confirmar antes de guardar
            if (confirm('¿Está seguro de guardar la clasificación manual y las fotos?')) {
                // Asegurarse de que los valores numéricos vacíos se conviertan a cero antes de enviar
                document.getElementById('verdes').value = document.getElementById('verdes').value || "0";
                document.getElementById('sobremaduros').value = document.getElementById('sobremaduros').value || "0";
                document.getElementById('dano_corona').value = document.getElementById('dano_corona').value || "0";
                document.getElementById('pedunculo_largo').value = document.getElementById('pedunculo_largo').value || "0";
                document.getElementById('podridos').value = document.getElementById('podridos').value || "0";

                // Si confirma, enviar el formulario programáticamente
                document.getElementById('main-form').submit(); 
                // Originalmente llamaba a procesarClasificacion(), pero ahora queremos el submit directo
                // procesarClasificacion();
            }
        });
        
        /* COMENTADO: La función procesarClasificacion ya no se llama directamente desde el botón guardar
           y contenía lógica compleja de envío con fetch que no es necesaria ahora.
           Se deja comentada por si se requiere recuperar alguna parte de su lógica.
        
        async function procesarClasificacion() {
            // Mostrar indicador de carga
// ... existing code ...
            }
            return hayImagenes;
        }
        */
    });
</script>
{% endblock %} 