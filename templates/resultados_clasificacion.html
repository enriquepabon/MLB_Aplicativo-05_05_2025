{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="card">
        <div class="card-body text-center">
            <i class="fas fa-check-circle text-success" style="font-size: 64px;"></i>
            <h2 class="mt-3">¡Registro Exitoso!</h2>
            <p class="lead">La clasificación manual y las fotos se han guardado correctamente.</p>
            
            <div class="mt-4">
                <h4>Detalles del Registro:</h4>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th>Código de Guía:</th>
                                    <td>{{ codigo_guia }}</td>
                                </tr>
                                <tr>
                                    <th>Fecha:</th>
                                    <td>{{ fecha_clasificacion or fecha_registro or 'No disponible' }}</td>
                                </tr>
                                <tr>
                                    <th>Hora:</th>
                                    <td>{{ hora_clasificacion or hora_registro or 'No disponible' }}</td>
                                </tr>
                                <tr>
                                    <th>Nombre:</th>
                                    <td>{{ nombre or 'No disponible' }}</td>
                                </tr>
                                <tr>
                                    <th>Cantidad de Racimos:</th>
                                    <td>{{ cantidad_racimos or 'No disponible' }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <h4>Clasificación Manual Registrada:</h4>
                <div class="row justify-content-center">
                    <div class="col-md-6">
                        <table class="table">
                            <tbody>
                                <tr>
                                    <th>Racimos Verdes:</th>
                                    <td>{{ clasificacion_manual.verdes or 0 }}</td>
                                </tr>
                                <tr>
                                    <th>Racimos Sobremaduros:</th>
                                    <td>{{ clasificacion_manual.sobremaduros or 0 }}</td>
                                </tr>
                                <tr>
                                    <th>Racimos con Daño en Corona:</th>
                                    <td>{{ clasificacion_manual.danio_corona or 0 }}</td>
                                </tr>
                                <tr>
                                    <th>Racimos Pendúnculo Largo:</th>
                                    <td>{{ clasificacion_manual.pendunculo_largo or 0 }}</td>
                                </tr>
                                <tr>
                                    <th>Racimos Podridos:</th>
                                    <td>{{ clasificacion_manual.podridos or 0 }}</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="mt-4">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i>
                    La clasificación automática está en proceso. Los resultados se actualizarán automáticamente.
                </div>
            </div>

            <div class="mt-4 d-flex justify-content-center gap-3">
                <a href="{{ url_for('serve_guia', filename='guia_' + codigo_guia + '.html') }}" class="btn btn-primary">
                    <i class="fas fa-file-alt"></i> Ver Guía
                </a>
                <a href="{{ url_for('clasificacion', codigo=codigo_guia) }}" class="btn btn-warning">
                    <i class="fas fa-redo"></i> Reintentar Clasificación
                </a>
                <button class="btn btn-success" onclick="iniciarEscaneoQR()">
                    <i class="fas fa-qrcode"></i> Escanear Otro QR
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Agregar la biblioteca jsQR -->
<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

<script>
let scannerInterval;

async function iniciarEscaneoQR() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment' }
        });
        
        // Crear elementos para la vista previa de la cámara
        const modal = document.createElement('div');
        modal.className = 'modal fade';
        modal.id = 'qrScannerModal';
        modal.innerHTML = `
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Escanear Código QR</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body text-center">
                        <video id="qrVideo" style="width: 100%; max-width: 500px;"></video>
                        <canvas id="qrCanvas" style="display: none;"></canvas>
                        <div id="loadingMessage" class="alert alert-info mt-3" style="display: none;">
                            <i class="fas fa-spinner fa-spin"></i> Buscando código QR...
                        </div>
                        <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Inicializar el modal de Bootstrap
        const modalInstance = new bootstrap.Modal(modal);
        modalInstance.show();
        
        // Configurar el video
        const video = document.getElementById('qrVideo');
        const canvas = document.getElementById('qrCanvas');
        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        
        video.srcObject = stream;
        await video.play();
        
        // Configurar el canvas para capturar frames
        const canvasContext = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        loadingMessage.style.display = 'block';
        
        // Función para procesar cada frame
        function procesarFrame() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
                
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                    inversionAttempts: "dontInvert",
                });
                
                if (code) {
                    // Detener el escaneo
                    clearInterval(scannerInterval);
                    
                    // Procesar la URL del QR
                    const url = code.data;
                    if (url.includes('/guias/')) {
                        // Extraer el código de guía de la URL
                        const match = url.match(/guia_(.+)\.html/);
                        if (match) {
                            const codigoGuia = match[1];
                            // Redirigir a la página de clasificación
                            window.location.href = `/clasificacion/${codigoGuia}`;
                        } else {
                            errorMessage.textContent = 'Código QR no válido';
                            errorMessage.style.display = 'block';
                        }
                    } else {
                        errorMessage.textContent = 'El código QR no contiene una URL de guía válida';
                        errorMessage.style.display = 'block';
                    }
                }
            }
        }
        
        // Iniciar el escaneo
        scannerInterval = setInterval(procesarFrame, 100);
        
        // Cuando se cierre el modal, detener todo
        modal.addEventListener('hidden.bs.modal', () => {
            clearInterval(scannerInterval);
            stream.getTracks().forEach(track => track.stop());
            modal.remove();
        });
        
    } catch (error) {
        console.error('Error al acceder a la cámara:', error);
        alert('Error al acceder a la cámara. Por favor, intente nuevamente.');
    }
}
</script>
{% endblock %} 