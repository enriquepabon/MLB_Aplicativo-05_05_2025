{% extends 'base.html' %}

{% block content %}
<div class="container my-4">
    <h2 class="mb-4 text-center">Resultados de Clasificación Automática</h2>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">Información de la Guía</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <p><strong>Código de Guía:</strong> {{ codigo_guia }}</p>
                    <p><strong>Código de Proveedor:</strong> {{ codigo_proveedor }}</p>
                    <p><strong>Nombre de Proveedor:</strong> {{ nombre_proveedor }}</p>
                </div>
                <div class="col-md-6">
                    <p><strong>Cantidad de Racimos:</strong> {{ cantidad_racimos }}</p>
                    <p><strong>Fecha de Registro:</strong> {{ fecha_registro }}</p>
                    <p><strong>Hora de Registro:</strong> {{ hora_registro }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Resultados por foto -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="card-title mb-0">Resultados por Foto</h5>
        </div>
        <div class="card-body">
            {% if imagenes_procesadas %}
                <ul class="nav nav-tabs" id="myTab" role="tablist">
                    {% for imagen in imagenes_procesadas %}
                    <li class="nav-item" role="presentation">
                        <button class="nav-link {% if loop.first %}active{% endif %}" 
                                id="foto{{ imagen.numero }}-tab" 
                                data-bs-toggle="tab" 
                                data-bs-target="#foto{{ imagen.numero }}" 
                                type="button" 
                                role="tab" 
                                aria-controls="foto{{ imagen.numero }}" 
                                aria-selected="{% if loop.first %}true{% else %}false{% endif %}">
                            Foto {{ imagen.numero }}
                        </button>
                    </li>
                    {% endfor %}
                </ul>
                <div class="tab-content" id="myTabContent">
                    {% for imagen in imagenes_procesadas %}
                    <div class="tab-pane fade {% if loop.first %}show active{% endif %}" 
                         id="foto{{ imagen.numero }}" 
                         role="tabpanel" 
                         aria-labelledby="foto{{ imagen.numero }}-tab">
                        
                        <div class="row mt-4">
                            <!-- Imágenes original y procesada -->
                            <div class="col-md-8">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">Foto Original</div>
                                            <div class="card-body text-center">
                                                <img src="/static/{{ imagen.original }}" class="img-fluid rounded" alt="Foto Original {{ imagen.numero }}">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="card">
                                            <div class="card-header">Foto Procesada</div>
                                            <div class="card-body text-center">
                                                {% if imagen.procesada %}
                                                <img src="/static/{{ imagen.procesada }}" class="img-fluid rounded" alt="Foto Procesada {{ imagen.numero }}">
                                                {% else %}
                                                <div class="alert alert-warning">Imagen procesada no disponible</div>
                                                {% endif %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resultados de detección -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">Resultados de Detección</div>
                                    <div class="card-body">
                                        {% if imagen.resultado and imagen.resultado is mapping and not imagen.resultado.error %}
                                            <p><strong>Racimos detectados:</strong> {{ imagen.resultado.potholes_detected }}</p>
                                            
                                            {% if imagen.resultado.detecciones %}
                                                <h6 class="mt-3">Detalle por Categoría:</h6>
                                                <ul class="list-group">
                                                    {% for categoria, cantidad in imagen.resultado.detecciones.items() %}
                                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                                        {{ categoria|replace('_', ' ')|title }}
                                                        <span class="badge bg-primary rounded-pill">{{ cantidad }}</span>
                                                    </li>
                                                    {% endfor %}
                                                </ul>
                                            {% endif %}
                                        {% elif imagen.resultado and imagen.resultado.error %}
                                            <div class="alert alert-danger">
                                                Error: {{ imagen.resultado.error }}
                                            </div>
                                        {% else %}
                                            <div class="alert alert-info">
                                                Procesamiento pendiente o en curso...
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="alert alert-warning">
                    No hay imágenes procesadas disponibles
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Resultados de la clasificación automática -->
    <div class="card mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="card-title mb-0">Resultados Automáticos (Total)</h5>
        </div>
        <div class="card-body">
            {% if resultados_automaticos %}
                <div class="table-responsive">
                    <table class="table table-striped table-bordered">
                        <thead class="table-dark">
                            <tr>
                                <th>Categoría</th>
                                <th>Cantidad</th>
                                <th>Porcentaje</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for categoria, datos in resultados_automaticos.items() %}
                            <tr>
                                <td>{{ categoria|replace('_', ' ')|title }}</td>
                                <td>{{ datos.cantidad if datos is mapping and 'cantidad' in datos else datos }}</td>
                                <td>
                                    {% if datos is mapping and 'porcentaje' in datos %}
                                        {{ datos.porcentaje }}%
                                    {% elif datos is number and cantidad_racimos and cantidad_racimos != 'No disponible' %}
                                        {{ (datos / cantidad_racimos * 100) | round(2) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-secondary">
                            <tr>
                                <th>Total detectado</th>
                                <th>{{ total_racimos_detectados }}</th>
                                <th>
                                    {% if cantidad_racimos and cantidad_racimos != 'No disponible' %}
                                        {{ (total_racimos_detectados / cantidad_racimos * 100) | round(2) }}%
                                    {% else %}
                                        N/A
                                    {% endif %}
                                </th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <!-- Información del procesamiento -->
                <div class="mt-3">
                    <p><strong>Tiempo de procesamiento:</strong> {{ tiempo_procesamiento }}</p>
                    <p><strong>Modelo utilizado:</strong> {{ modelo_utilizado }}</p>
                    <p>
                        <strong>Estado:</strong>
                        {% if workflow_completado %}
                            <span class="badge bg-success">Completado</span>
                        {% else %}
                            <span class="badge bg-warning">En proceso</span>
                        {% endif %}
                    </p>
                </div>
            {% else %}
                <div class="alert alert-warning">
                    No hay datos de clasificación automática disponibles.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Botones de acciones -->
    <div class="d-flex justify-content-between">
        <a href="/ver_resultados_clasificacion/{{ codigo_guia }}" class="btn btn-primary">
            Ver Clasificación Manual
        </a>
        <a href="/clasificaciones/lista" class="btn btn-secondary">
            Volver al Listado
        </a>
        <a href="/guias/guia_{{ codigo_guia }}.html" class="btn btn-info">
            Ver Guía Original
        </a>
    </div>
</div>
{% endblock %} 